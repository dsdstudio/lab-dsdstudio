<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="chrome=1">
<title>Webgl-study by dsdstudio</title>
<link rel="stylesheet" href="css/styles.css">
<link rel="stylesheet" href="css/pygment_trac.css">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<script src="js/glMatrix-0.9.5.min.js"></script>
<script>
function initGL(canvas) {
	// webgl 초기화
	gl=canvas.getContext("webgl")||canvas.getContext("experimental-webgl");
	if (!gl) return alert("지원안되는 브라우저라능 !");
	console.log(gl);
	gl.viewportWidth = canvas.width, 
	gl.viewportHeight = canvas.height;
}

function getShader(gl, id) {
	var shaderStr = {
		"fragment":[
			"precision mediump float;",
			"void main(void) {",
				"gl_FragColor = vec4(0.3, 1.0, 1.0, 1.0);",
			"}"
		].join("\n"),
		"vertex":[
			"attribute vec3 aVertexPosition;",
			"uniform mat4 uMVMatrix;",
			"uniform mat4 uPMatrix;",
			"void main(void) {",
				"gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);",
			"}"
		].join("\n")
	}[id];
	if (!shaderStr) return null;

	// 쉐이더 만들기
	var shaderConstant = { "fragment":gl.FRAGMENT_SHADER, "vertex":gl.VERTEX_SHADER }[id];
	var shader = gl.createShader(shaderConstant);

	// GPU한테 shader code 와 shader 를 컴파일해달라고 요청~ 
	gl.shaderSource(shader, shaderStr);
	gl.compileShader(shader);

	// GPU한테 컴퐈일 제대로 됐는지 물어봄 ~ 잘못됐으면 메시지 받아다가 알럿
	if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
		alert(gl.getShaderInfoLog(shader));
		return null;
	}
	return shader;
}

var shaderProgram;
function initShaders() {
	// 컴퐈일된 shader객체를 얻어옴 
	var fragmentShader=getShader(gl, "fragment");
	var vertexShader=getShader(gl, "vertex");

	// 쉐이더를 사용하기위해 프로그램 만들기
	shaderProgram=gl.createProgram();
	
	// 프로그램에서 쓸 쉐이더를 쉐이더를 붙입니다. 
	gl.attachShader(shaderProgram, vertexShader);	
	gl.attachShader(shaderProgram, fragmentShader);	

	// GPU한테 프로그램 링크해달라고 요청 
	gl.linkProgram(shaderProgram);

	if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)){
		alert("문제있음 " );
	}

	// GPU에게 요 쉐이더 프로그램 쓸거라고 선언합니다. 
	gl.useProgram(shaderProgram);

	// 비디오 메모리(VRAM) 내의 attributePosition 을 얻어옵니다.
	shaderProgram.vertexPositionAttribute=gl.getAttribLocation(shaderProgram, "aVertexPosition");
	
	// 지퓨한데 담당할 버텍스 정보를 알려줍니다~
	gl.enableVertexAttribArray(shaderProgram.vertexPositionAttribute);
	
	// shader 에 상수 알려줌
	shaderProgram.pMatrixUniform=gl.getUniformLocation(shaderProgram, "uPMatrix");
	shaderProgram.mvMatrixUniform=gl.getUniformLocation(shaderProgram, "uMVMatrix");
}

var mvMatrix=mat4.create();
var pMatrix=mat4.create();
function setMatrixUniforms() {
	gl.uniformMatrix4fv(shaderProgram.pMatrixUniform, false, pMatrix);
	gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mvMatrix);
}

var squareVertexPositionBuffer;
function initBuffers() {
	// GPU한테 버퍼만들어달라고 요청
	squareVertexPositionBuffer = gl.createBuffer();
	// 만든담에 요런 타입의 버퍼라고 GPU한테 알려줌 
	gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer);
	// 점 데이터. 이게 사실상 사각형 
	// item 3개짜리 배열 4개를 쓸수도 있지만 GPU의 세계에서는 1차원 배열로 주는게 GPU가 처리하기 수월함.
	var verticies = [
		1.0, 1.0, 0.0,
		-1.0, 1.0, 0.0,
		1.0, -1.0, 0.0,
		-1.0, -1.0, 0.0
	];

	// 버퍼에다가 지오메트리 점(버텍스)정보를 꽂아준다. 
	// ArrayType은 GPU가 사용하는 타입으로 재변환해서 적정수준의 부동소수점타입을 담을수있는 배열형태로 
	gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verticies), gl.STATIC_DRAW);

	// 평면 인식을 x,y,z 3개씩 끊어서 인식한다고 알려주기 
	squareVertexPositionBuffer.itemSize=3;
	// 점(버텍스) 갯수는 4개라고 알려줌 
	squareVertexPositionBuffer.numItems=4;
}

function drawScene() {
	gl.viewport(0, 0, gl.viewportWidth, gl.viewportHeight);
	gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
	
	mat4.perspective(45, gl.viewportWidth / gl.viewportHeight, 0.1, 100.0, pMatrix);
	// MBO 초기화 
	mat4.identity(mvMatrix);
	mat4.translate(mvMatrix, [0.0, 0.0, -7]);

	gl.bindBuffer(gl.ARRAY_BUFFER, squareVertexPositionBuffer);
	gl.vertexAttribPointer(shaderProgram.vertexPositionAttribute, squareVertexPositionBuffer.itemSize, gl.FLOAT, false, 0, 0);
	setMatrixUniforms(); 
	gl.drawArrays(gl.TRIANGLE_STRIP, 0, squareVertexPositionBuffer.numItems);
}

function glStart() {
	var canvas=document.getElementById("glcanvas");
	initGL(canvas);
	initShaders();
	initBuffers();

	gl.clearColor(0.0, 0.0, 0.0, 1.0);

	gl.enable(gl.DEPTH_TEST);
	drawScene();
}

</script>
</head>
<body onload="glStart()">
	<p>WebGL로 사각형 그리기</p>
	<canvas id="glcanvas" width="800" height="600"></canvas>
</body>
</html>
